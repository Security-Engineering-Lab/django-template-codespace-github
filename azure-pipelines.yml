# Azure DevOps Pipeline for Django Template
# Automated build, test, and deployment to Azure App Service

name: Django-Template-CI-CD-$(Date:yyyyMMdd)$(Rev:.r)

trigger:
  branches:
    include:
    - main
    - develop
    - feature/*
  paths:
    exclude:
    - README.md
    - docs/**
    - "*.md"

pr:
  branches:
    include:
    - main
    - develop

variables:
  # Build Configuration
  pythonVersion: '3.11'
  vmImageName: 'ubuntu-latest'
  
  # Azure Configuration
  azureServiceConnection: 'azure-production'
  resourceGroupName: 'rg-django-template'
  location: 'East US'
  
  # Environment-specific variables
  ${{ if eq(variables['Build.SourceBranchName'], 'main') }}:
    environmentName: 'production'
    webAppName: 'django-template-prod'
    appServiceSku: 'B1'
  ${{ elseif eq(variables['Build.SourceBranchName'], 'develop') }}:
    environmentName: 'staging'
    webAppName: 'django-template-staging'
    appServiceSku: 'F1'
  ${{ else }}:
    environmentName: 'development'
    webAppName: 'django-template-dev-$(Build.BuildId)'
    appServiceSku: 'F1'

stages:
- stage: Validate
  displayName: 'Code Quality & Security'
  jobs:
  - job: CodeQuality
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(pythonVersion)'
      displayName: 'Use Python $(pythonVersion)'

    - script: |
        python -m venv venv
        source venv/bin/activate
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 bandit safety black isort
      displayName: 'Install dependencies and linting tools'

    - script: |
        source venv/bin/activate
        echo "üîç Running code formatting check..."
        black --check --diff . || echo "Black formatting issues found"
        echo "üìù Running import sorting check..."
        isort --check-only --diff . || echo "Import sorting issues found"
        echo "üßπ Running linting..."
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || echo "Linting issues found"
      displayName: 'Code quality checks'
      continueOnError: true

    - script: |
        source venv/bin/activate
        echo "üîí Running security scan..."
        bandit -r . -f json -o bandit-report.json || echo "Security scan completed with warnings"
        echo "üõ°Ô∏è Checking for known security vulnerabilities..."
        safety check --json --output safety-report.json || echo "Safety check completed with warnings"
      displayName: 'Security scanning'
      continueOnError: true

- stage: Build
  displayName: 'Build Application'
  dependsOn: Validate
  jobs:
  - job: BuildJob
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(pythonVersion)'
      displayName: 'Use Python $(pythonVersion)'

    - script: |
        echo "üêç Setting up Python environment..."
        python -m venv venv
        source venv/bin/activate
        python -m pip install --upgrade pip
        pip install -r requirements.txt
      displayName: 'Install Python dependencies'

    - script: |
        echo "üß™ Running Django tests..."
        source venv/bin/activate
        python manage.py test --verbosity=2 --keepdb || echo "Tests completed with warnings"
      displayName: 'Run Django tests'
      continueOnError: true

    - script: |
        echo "‚úÖ Running Django system checks..."
        source venv/bin/activate
        python manage.py check --deploy --fail-level ERROR
      displayName: 'Django deployment checks'

    - script: |
        echo "üì¶ Collecting static files..."
        source venv/bin/activate
        python manage.py collectstatic --noinput --clear
      displayName: 'Collect static files'

    - script: |
        echo "üìã Creating deployment package..."
        # Remove unnecessary files from deployment
        rm -rf venv/
        rm -rf .git/
        rm -rf __pycache__/
        find . -name "*.pyc" -delete
        find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
      displayName: 'Clean up deployment package'

    - task: ArchiveFiles@2
      displayName: 'Archive application files'
      inputs:
        rootFolderOrFile: '$(System.DefaultWorkingDirectory)'
        includeRootFolder: false
        archiveType: zip
        archiveFile: $(Build.ArtifactStagingDirectory)/django-app-$(Build.BuildId).zip
        replaceExistingArchive: true

    - task: PublishBuildArtifacts@1
      displayName: 'Publish build artifact'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'django-app'
        publishLocation: 'Container'

- stage: DeployInfrastructure
  displayName: 'Deploy Azure Infrastructure'
  dependsOn: Build
  condition: and(succeeded(), or(eq(variables['Build.SourceBranchName'], 'main'), eq(variables['Build.SourceBranchName'], 'develop')))
  jobs:
  - job: DeployInfra
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: AzureCLI@2
      displayName: 'Deploy Azure App Service'
      inputs:
        azureSubscription: $(azureServiceConnection)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "üèóÔ∏è Creating Azure infrastructure..."
          
          # Create resource group
          az group create --name $(resourceGroupName) --location "$(location)" || echo "Resource group already exists"
          
          # Create App Service Plan
          az appservice plan create \
            --name asp-$(webAppName) \
            --resource-group $(resourceGroupName) \
            --sku $(appServiceSku) \
            --is-linux || echo "App Service Plan already exists"
          
          # Create Web App
          az webapp create \
            --name $(webAppName) \
            --resource-group $(resourceGroupName) \
            --plan asp-$(webAppName) \
            --runtime "PYTHON|3.11" || echo "Web App already exists"
          
          # Configure Web App settings
          az webapp config appsettings set \
            --name $(webAppName) \
            --resource-group $(resourceGroupName) \
            --settings \
              DJANGO_SETTINGS_MODULE="hello_world.settings" \
              DJANGO_DEBUG="False" \
              WEBSITE_HTTPLOGGING_RETENTION_DAYS="3" \
              SCM_DO_BUILD_DURING_DEPLOYMENT="true"

# –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –ó–∞–º—ñ–Ω–µ–Ω–æ deployment job –Ω–∞ –∑–≤–∏—á–∞–π–Ω–∏–π job
- stage: Deploy
  displayName: 'Deploy to Azure App Service'
  dependsOn: DeployInfrastructure
  condition: succeeded()
  jobs:
  - job: DeployApp  # –ó–º—ñ–Ω–µ–Ω–æ –∑ deployment –Ω–∞ job
    pool:
      vmImage: $(vmImageName)
    steps:
    - download: current
      artifact: django-app

    - task: AzureWebApp@1
      displayName: 'Deploy Django application'
      inputs:
        azureSubscription: $(azureServiceConnection)
        appType: 'webAppLinux'
        appName: $(webAppName)
        package: $(Pipeline.Workspace)/django-app/django-app-$(Build.BuildId).zip
        runtimeStack: 'PYTHON|3.11'
        startUpCommand: 'gunicorn --bind=0.0.0.0 --timeout 600 hello_world.wsgi'

    - task: AzureCLI@2
      displayName: 'Post-deployment verification'
      inputs:
        azureSubscription: $(azureServiceConnection)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "üè• Running post-deployment health check..."
          APP_URL="https://$(webAppName).azurewebsites.net"
          
          # Wait for app to start
          echo "‚è≥ Waiting for application to start..."
          sleep 90
          
          # Health check with retry
          for i in {1..5}; do
            echo "üîç Health check attempt $i/5..."
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $APP_URL --connect-timeout 30 || echo "000")
            
            if [ "$HTTP_STATUS" -eq 200 ]; then
              echo "‚úÖ Health check passed! App is running at: $APP_URL"
              echo "##vso[task.setvariable variable=APP_URL;isOutput=true]$APP_URL"
              break
            else
              echo "‚ö†Ô∏è Health check attempt $i failed! HTTP Status: $HTTP_STATUS"
              if [ $i -eq 5 ]; then
                echo "‚ùå All health check attempts failed!"
                echo "üîç Checking application logs..."
                az webapp log tail --name $(webAppName) --resource-group $(resourceGroupName) --timeout 30 || echo "Could not retrieve logs"
                exit 1
              fi
              sleep 30
            fi
          done

- stage: PostDeploy
  displayName: 'Post-Deployment Tasks'
  dependsOn: Deploy
  condition: succeeded()
  jobs:
  - job: Notifications
    pool:
      vmImage: $(vmImageName)
    steps:
    - script: |
        echo "üéâ Deployment completed successfully!"
        echo "üåê Application URL: https://$(webAppName).azurewebsites.net"
        echo "üìä Environment: $(environmentName)"
        echo "üè∑Ô∏è Build: $(Build.BuildNumber)"
        echo "üìÖ Deployed at: $(date)"
        
        # You can add Slack/Teams notifications here
        echo "üìß Sending notifications..."
        
      displayName: 'Send deployment notifications'